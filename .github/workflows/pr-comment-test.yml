name: PR Test via Comment

# This workflow allows maintainers to test specific PRs by commenting on any issue or PR.
# 
# Usage:
#   Comment "#test <NF1> <PR1> [<PR2> ...] [<NF2> <PR3> ...]" in any issue or PR comment.
#
# Examples:
#   #test smf 187 188 amf 142
#   #test amf 193
#   #test smf 170 183 192 udm 80 81 amf 50
#
# This triggers the ci-operation-pr.sh script from free5gc/ci-test repository.
#
# Organization Runner Setup:
#   1. Go to Organization Settings > Actions > Runners
#   2. Click "New self-hosted runner"
#   3. Follow the instructions to install and configure the runner
#   4. Add labels: self-hosted, linux, x64
#   5. For repository access, select "All repositories" or specific repos
#   6. Runner must have: Docker, curl, jq, Go environment installed

on:
  issue_comment:
    types: [created]

env:
  CI_TEST_REPO: https://github.com/free5gc/ci-test
  CI_TEST_DIR: ci-test

jobs:
  pr-test:
    name: PR Test from Comment
    # Trigger only when:
    # 1. Comment contains "#test" pattern
    # 2. Commenter has write permission or higher (member/admin)
    if: |
      contains(github.event.comment.body, '#test')
    runs-on: [self-hosted, linux, x64]
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: Check user permission
        id: check_permission
        uses: actions/github-script@v7
        with:
          script: |
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.payload.comment.user.login
            });
            
            const allowedPermissions = ['admin', 'write'];
            if (!allowedPermissions.includes(permission.permission)) {
              core.setOutput('allowed', 'false');
              console.log(`User ${context.payload.comment.user.login} has ${permission.permission} permission. Not allowed.`);
              return;
            }
            
            core.setOutput('allowed', 'true');
            console.log(`User ${context.payload.comment.user.login} has ${permission.permission} permission. Allowed.`);

      - name: Comment on permission denied
        if: steps.check_permission.outputs.allowed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `⚠️ @${context.payload.comment.user.login} does not have permission to trigger PR tests. Only repository collaborators with write access can use this feature.`
            });
            core.setFailed('Permission denied');

      - name: Parse test command
        id: parse
        if: steps.check_permission.outputs.allowed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            
            // Match #test followed by arguments (NF names and PR numbers)
            // Pattern: #test <args> - arguments must be on the same line as #test
            const match = comment.match(/#test\s+(.+?)(?:\n|$)/);
            
            if (!match) {
              core.setFailed('Could not parse test command. Expected format: #test <nf_name> <pr_number> [<pr_number> ...] [<nf_name> <pr_number> ...]');
              return;
            }
            
            const args = match[1].trim();
            console.log(`Parsed arguments: ${args}`);
            
            // Validate the arguments: NF names must precede their PR numbers
            const parts = args.split(/\s+/);
            const supportedNFs = ['amf', 'ausf', 'bsf', 'chf', 'n3iwf', 'nef', 'nrf', 'nssf', 'pcf', 'smf', 'tngf', 'udm', 'udr', 'upf', 'webconsole'];
            
            let currentNF = null;
            let hasValidPair = false;
            
            for (const part of parts) {
              if (supportedNFs.includes(part.toLowerCase())) {
                currentNF = part.toLowerCase();
              } else if (/^\d+$/.test(part)) {
                if (currentNF === null) {
                  core.setFailed(`Invalid format: PR number "${part}" must follow an NF name. Expected format: #test <nf_name> <pr_number> [<pr_number> ...]`);
                  return;
                }
                hasValidPair = true;
              } else {
                core.setFailed(`Unknown argument: "${part}". Must be a supported NF name or PR number.`);
                return;
              }
            }
            
            if (!hasValidPair) {
              core.setFailed('Invalid arguments. Must include at least one NF name followed by one PR number.');
              return;
            }
            
            core.setOutput('args', args);
            core.setOutput('valid', 'true');

      - name: Add reaction to comment
        if: steps.parse.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Check system commands
        if: steps.parse.outputs.valid == 'true'
        run: |
          echo "Checking required commands..."
          docker --version
          curl --version
          jq --version
          go version

      - name: Clone free5gc/ci-test
        if: steps.parse.outputs.valid == 'true'
        run: |
          rm -rf ${{ env.CI_TEST_DIR }}
          git clone ${{ env.CI_TEST_REPO }}

      - name: Run ci-operation-pr.sh
        if: steps.parse.outputs.valid == 'true'
        run: |
          cd ${{ env.CI_TEST_DIR }}
          chmod +x ci-operation-pr.sh
          echo "Running: ./ci-operation-pr.sh nf ${{ steps.parse.outputs.args }}"
          ./ci-operation-pr.sh nf ${{ steps.parse.outputs.args }}

      - name: Upload test report
        if: always() && steps.parse.outputs.valid == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pr-test-report-${{ github.run_id }}
          path: ${{ env.CI_TEST_DIR }}/testing_output/
          if-no-files-found: ignore

      - name: Add success comment
        if: success() && steps.parse.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `✅ PR Test completed successfully!\n\nTest arguments: \`${{ steps.parse.outputs.args }}\`\n\nSee [workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`
            });

      - name: Add failure comment
        if: failure() && steps.parse.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `❌ PR Test failed!\n\nTest arguments: \`${{ steps.parse.outputs.args }}\`\n\nSee [workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`
            });

      - name: Cleanup docker resources
        if: always() && steps.parse.outputs.valid == 'true'
        run: |
          echo "Cleaning up docker resources..."
          docker system prune -f || true
          docker volume prune -f || true

      - name: Clean up clone repositories
        if: always() && steps.parse.outputs.valid == 'true'
        run: |
          rm -rf ${{ env.CI_TEST_DIR }}
